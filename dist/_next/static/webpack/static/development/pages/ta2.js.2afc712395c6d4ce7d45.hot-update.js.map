{"version":3,"file":"static/webpack/static/development/pages/ta2.js.2afc712395c6d4ce7d45.hot-update.js","sources":["webpack:///./pages/ta2.tsx"],"sourcesContent":["import React from 'react';\nimport {Button, Col, ProgressBar, Row} from 'react-bootstrap';\nimport {Title} from '../src/components/text';\nimport {ButtonBox, CustomContainer} from '../src/components/box';\nimport Router from 'next/router';\n\nconst PAN_LEFT = -1;\nconst PAN_RIGHT = 1;\nconst CANDIDATE_FREQUENCIES = [250, 500, 1000, 2000, 4000, 8000];\nconst CANDIDATE_GAIN = [0.001, 0.002, 0.003, 0.004, 0.006, 0.01];\nconst GAIN_MAX_VALUE = CANDIDATE_GAIN[CANDIDATE_GAIN.length - 1];\n\nenum Pan {\n  Left = 'Left',\n  Right = 'Right',\n}\n\ninterface IResult {\n  frequency: number;\n  pan: Pan;\n  volume: number;\n  correct: boolean;\n}\n\ninterface IState {\n  isSideChanged: boolean;\n  step: number;\n  isFinished: boolean;\n  frequency: number;\n  pan: Pan;\n  volume: number;\n  results: Array<IResult>;\n}\n\nclass Ta1 extends React.Component {\n  private audioContext: AudioContext;\n  private oscillator: OscillatorNode;\n  private gainNode: GainNode;\n  private panNode: StereoPannerNode;\n  private audioContextHistory: AudioContext[] = [];\n\n  state: IState = {\n    isSideChanged: false,\n    step: 1,\n    isFinished: false,\n    frequency: undefined,\n    pan: undefined,\n    volume: undefined,\n    results: [],\n  };\n\n  componentDidMount(): void {\n    console.log('componentDidMount');\n    this.initAudio();\n    setTimeout(() => {\n      try {\n        this.oscillator.stop();\n      } catch (e) {\n        console.warn(e);\n      }\n      this.oscillator.start();\n    }, 300);\n  }\n\n  private initAudio() {\n    const W = window as any;\n    this.audioContext = new (W.AudioContext || W.webkitAudioContext)();\n    this.audioContextHistory.push(this.audioContext);\n    this.oscillator = this.audioContext.createOscillator();\n    this.gainNode = this.audioContext.createGain();\n    this.panNode = this.audioContext.createStereoPanner();\n\n    this.oscillator.type = 'sine';\n    this.oscillator.frequency.value = 440;\n\n    this.oscillator.connect(this.panNode);\n    this.panNode.connect(this.gainNode);\n    this.panNode.pan.value = PAN_LEFT;\n\n    this.oscillator.connect(this.gainNode);\n    this.gainNode.connect(this.audioContext.destination);\n    this.gainNode.gain.value = GAIN_MAX_VALUE;\n    console.log('this.gainNode.gain.value', this.gainNode.gain.value);\n  }\n\n  componentWillUnmount(): void {\n    console.log('componentWillUnmount');\n    try {\n      this.gainNode.gain.value = 0;\n      this.panNode.pan.value = 0;\n      this.oscillator.disconnect();\n      this.audioContext.close();\n    } catch (err) {\n      console.error('stopAudio error');\n    } finally {\n      this.stopAudio();\n    }\n  }\n\n  private getRandomGain() {\n    return CANDIDATE_GAIN[Math.floor(Math.random() * (CANDIDATE_GAIN.length - 2))];\n  }\n\n  private getRandomFrequency() {\n    return CANDIDATE_FREQUENCIES[Math.floor(Math.random() * CANDIDATE_FREQUENCIES.length)];\n  }\n\n  private stopAudio() {\n    try {\n      this.audioContextHistory.map(async (context) => {\n        try {\n          await context.close()\n        } catch (err) {\n        }\n      });\n    } catch (err) {\n      console.error('stopAudio error');\n    }\n\n    try {\n      // this.audioContextHistory.forEach(async () => await ());\n      this.gainNode.gain.value = 0;\n      this.oscillator.disconnect();\n      this.audioContext.close();\n      this.audioContext = null;\n      this.gainNode = null;\n      this.panNode = null;\n    } catch (err) {\n      console.error('stopAudio error');\n    }\n  }\n\n  private startAudio() {\n    const W = window as any;\n    const frequency = this.getRandomFrequency();\n    const pan = Math.random() < 0.5 ? PAN_LEFT : PAN_RIGHT;\n    const volume = this.getRandomGain();\n\n    this.setState({frequency, pan, volume});\n\n    this.audioContext = new (W.AudioContext || W.webkitAudioContext)();\n    this.audioContextHistory.push(this.audioContext);\n    this.oscillator = this.audioContext.createOscillator();\n    this.gainNode = this.audioContext.createGain();\n    this.panNode = this.audioContext.createStereoPanner();\n\n    this.oscillator.type = 'sine';\n    this.oscillator.frequency.value = frequency;\n\n    this.oscillator.connect(this.panNode);\n    this.panNode.connect(this.gainNode);\n    this.panNode.pan.value = pan;\n\n    this.oscillator.connect(this.gainNode);\n    this.gainNode.connect(this.audioContext.destination);\n    this.gainNode.gain.value = volume;\n\n    console.log('this.oscillator.frequency.value ', this.oscillator.frequency.value);\n    console.log('this.panNode.pan.value', this.panNode.pan.value);\n    console.log('this.gainNode.gain.value', this.gainNode.gain.value);\n\n    this.oscillator.start();\n  }\n\n  render() {\n    if (this.state.isFinished) {\n      return (\n        <div>\n          <CustomContainer className=\"my-3 p-3 bg-white\">\n            <Row>\n              <Col className=\"col-sm-12 mb-5\">\n                <Title>\n                  검사가<br />\n                  <span className=\"text-primary\">종료</span>되었습니다.<br />\n                </Title>\n              </Col>\n            </Row>\n          </CustomContainer>\n        </div>\n      );\n    }\n\n    return (\n      <div>\n        <CustomContainer className=\"my-3 p-3 bg-white\">\n          <Row>\n            <Col className=\"col-sm-12 mb-5\">\n              <Title>\n                <span className=\"text-primary\">어느 쪽 귀</span>에서 들리시나요?<br />\n              </Title>\n              #{this.state.step}\n            </Col>\n          </Row>\n          <Row>\n            <Col className=\"col-sm-12 mb-5\">\n              <ProgressBar\n                now={this.state.step}\n                min={0}\n                max={20}\n              />\n            </Col>\n          </Row>\n          <ButtonBox className=\"align-items-end\">\n            <Col className=\"col-12 mt-2 text-center\">\n              <Button className=\"btn-block\" onClick={() => this.handleNothing()}>들리지 않음</Button>\n            </Col>\n            <Col className=\"col-12 mt-2 text-center\">\n              <Button className=\"btn-block\" onClick={() => this.handleLeft()}>왼쪽</Button>\n            </Col>\n            <Col className=\"col-12 mt-2 text-center\">\n              <Button className=\"btn-block\" onClick={() => this.handleRight()}>오른쪽</Button>\n            </Col>\n          </ButtonBox>\n        </CustomContainer>\n      </div>\n    )\n  }\n\n  private saveResult({choice}: { choice?: Pan }) {\n    this.setState((prevState: IState) => {\n      const resultOfCurrentStep: IResult = {\n        frequency: prevState.frequency,\n        pan: prevState.pan,\n        volume: prevState.volume,\n        correct: prevState.isSideChanged ? prevState.pan !== choice : prevState.pan === choice,\n      };\n\n      return {results: prevState.results.concat([resultOfCurrentStep])};\n    });\n  }\n\n  private goToNextSound() {\n    const {step} = this.state;\n\n    if (step === 20) {\n      this.finishTest();\n      return;\n    }\n\n    this.setState((prevState: IState) => ({step: prevState.step + 1}));\n    setTimeout(() => this.startAudio(), 300);\n  }\n\n  private finishTest() {\n    this.setState({isFinished: true});\n    setTimeout(() => this.stopAudio(), 500);\n  }\n\n  private handleNothing() {\n    const {step} = this.state;\n\n    this.stopAudio();\n\n    if (step === 1) {\n      Router.push('/wrong?msg=들리지%20않음');\n      return;\n    }\n\n    this.saveResult({choice: undefined});\n    this.goToNextSound();\n  }\n\n  private handleLeft() {\n    const {step} = this.state;\n\n    this.stopAudio();\n\n    if (step === 1) {\n      this.setState({isSideChanged: false, step: 2});\n      setTimeout(() => this.startAudio(), 100);\n      return;\n    }\n\n    this.saveResult({choice: Pan.Left});\n    this.goToNextSound();\n  }\n\n  private handleRight() {\n    const {step} = this.state;\n\n    this.stopAudio();\n\n    if (step === 1) {\n      this.setState({isSideChanged: true, step: 2});\n      setTimeout(() => this.startAudio(), 100);\n      return;\n    }\n\n    this.saveResult({choice: Pan.Right});\n    this.goToNextSound();\n  }\n}\n\nexport default Ta1;"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AADA;AAAA;AAAA;AAAA;AACA;AAqBA;;;;;;;;;;;;;;;;;;AAKA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAPA;AACA;;;;;;AASA;AAAA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;;;AAEA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AAEA;AACA;AACA;;;AAEA;AACA;AACA;;;AAEA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AADA;AAAA;AAAA;AACA;AADA;AAAA;AAAA;AACA;AADA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AADA;AAAA;AAAA;AAAA;AAMA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AAEA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;;;AAEA;AAAA;AACA;AAAA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAOA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAKA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AAHA;AAAA;AAAA;AAAA;AAAA;AAAA;AAOA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAMA;;;AAEA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AAJA;AAOA;AAAA;AAAA;AACA;AACA;;;AAEA;AAAA;AACA;AADA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;;;AAEA;AAAA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;;;AAEA;AAAA;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;;;AAEA;AAAA;AACA;AADA;AAGA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;;;AAEA;AAAA;AACA;AADA;AAGA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AACA;;;;AAhQA;AACA;AAkQA;;;;A","sourceRoot":""}